FROM {{ base_image | default('python:3.11-slim') }}

# System packages
RUN apt-get update && apt-get install -y \
    curl git bash tmux zsh jq \
    {% for pkg in apt_packages %}{{ pkg }} {% endfor %}\
    && rm -rf /var/lib/apt/lists/*

# Python venv with project dependencies
RUN python3 -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"
ENV VIRTUAL_ENV="/opt/venv"

{% if requirements_content %}
COPY requirements.txt /tmp/requirements.txt
RUN pip install --no-cache-dir -r /tmp/requirements.txt
{% endif %}

# Non-root user
RUN useradd -m -s /bin/bash scad \
    && chown -R scad:scad /opt/venv \
    && mkdir -p /workspace /scad-logs \
    && chown -R scad:scad /workspace /scad-logs

# Set PATH before Claude install (suppresses "~/.local/bin not in PATH" warning)
USER scad
ENV PATH="/home/scad/.local/bin:$PATH"

# Install Claude Code via native installer
WORKDIR /tmp
RUN curl -fsSL https://claude.ai/install.sh | bash
ENV DISABLE_AUTOUPDATER=1

# Container DX: oh-my-zsh + tmux config
RUN sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
ENV TERM=xterm-256color
COPY .tmux.conf /home/scad/.tmux.conf

# Bootstrap scripts for Claude plugin installation
USER root
COPY bootstrap-claude.sh bootstrap-claude.conf /home/scad/
RUN chmod +x /home/scad/bootstrap-claude.sh
COPY statusline.sh /home/scad/statusline.sh
RUN chmod +x /home/scad/statusline.sh

# Entrypoint
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

USER scad
WORKDIR /home/scad

ENTRYPOINT ["/entrypoint.sh"]
