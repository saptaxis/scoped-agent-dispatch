FROM {{ base_image | default('python:3.11-slim') }}

# System packages
RUN apt-get update && apt-get install -y \
    curl git bash tmux \
    {% for pkg in apt_packages %}{{ pkg }} {% endfor %}\
    && rm -rf /var/lib/apt/lists/*

# Python venv with project dependencies
RUN python3 -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"
ENV VIRTUAL_ENV="/opt/venv"

{% if requirements_content %}
COPY requirements.txt /tmp/requirements.txt
RUN pip install --no-cache-dir -r /tmp/requirements.txt
{% endif %}

# Non-root user (Claude Code refuses --dangerously-skip-permissions as root)
RUN useradd -m -s /bin/bash scad \
    && chown -R scad:scad /opt/venv \
    && mkdir -p /workspace /scad-logs \
    && chown -R scad:scad /workspace /scad-logs

# Install Claude Code via native installer (as scad user)
USER scad
WORKDIR /tmp
RUN curl -fsSL https://claude.ai/install.sh | bash
ENV PATH="/home/scad/.local/bin:$PATH"
ENV DISABLE_AUTOUPDATER=1

# Bootstrap scripts for Claude plugin installation
USER root
COPY bootstrap-claude.sh bootstrap-claude.conf /home/scad/
RUN chmod +x /home/scad/bootstrap-claude.sh

# Entrypoint (must be readable by scad user)
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

USER scad
WORKDIR /home/scad

ENTRYPOINT ["/entrypoint.sh"]
