#!/bin/bash
set -euo pipefail

RUN_ID="${RUN_ID:?RUN_ID not set}"
PROMPT="${AGENT_PROMPT:-}"
LOG_FILE="/scad-logs/${RUN_ID}.log"
STREAM_LOG="/scad-logs/${RUN_ID}.stream.jsonl"
STATUS_FILE="/scad-logs/${RUN_ID}.status.json"
START_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)

# Write status on exit (SIGTERM from scad stop)
write_status() {
    set -e
    END_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)
    cat > "$STATUS_FILE" <<STATUSEOF
{
  "run_id": "$RUN_ID",
  "config": "{{ config_name }}",
  "exit_code": ${EXIT_CODE:-0},
  "started": "$START_TIME",
  "finished": "$END_TIME"
}
STATUSEOF
    echo "[scad] Session finished"
}
trap write_status EXIT

# Capture all output to log file AND stdout
exec > >(tee -a "$LOG_FILE") 2>&1

echo "[scad] Starting session (run: $RUN_ID)"

# Seed Claude config — merge seed values into existing .claude.json
mkdir -p "$HOME/.claude"
python3 -c "
import json, pathlib
target = pathlib.Path('$HOME/.claude.json')
seed = json.loads(pathlib.Path('/home/scad/seed-claude.json').read_text())
existing = json.loads(target.read_text()) if target.exists() else {}
existing.update(seed)
target.write_text(json.dumps(existing, indent=2))
"

# Copy host git config if mounted
if [ -f /mnt/host-gitconfig ]; then
    cp /mnt/host-gitconfig "$HOME/.gitconfig"
fi
git config --global --add safe.directory '*'

# Configure git-delta for better diffs
git config --global core.pager delta
git config --global interactive.diffFilter 'delta --color-only'
git config --global delta.navigate true

# Copy host Claude credentials if mounted (staging path avoids stale-inode
# problem when user runs /login on host — new file = new inode, direct mount
# would keep showing old content)
if [ -f /mnt/host-claude-credentials.json ]; then
    mkdir -p "$HOME/.claude"
    cp /mnt/host-claude-credentials.json "$HOME/.claude/.credentials.json"
fi

# Seed Claude settings — merge seed values into existing settings.json
CLAUDE_DIR="$HOME/.claude"
if [ ! -f "$CLAUDE_DIR/settings.json" ]; then
    echo '{}' > "$CLAUDE_DIR/settings.json"
fi
python3 -c "
import json, pathlib
target = pathlib.Path('$CLAUDE_DIR/settings.json')
seed = json.loads(pathlib.Path('/home/scad/seed-settings.json').read_text())
existing = json.loads(target.read_text()) if target.exists() else {}
existing.update(seed)
target.write_text(json.dumps(existing, indent=2))
"

# Install Claude plugins (idempotent — skips already-installed)
if [ -f "$HOME/bootstrap-claude.sh" ]; then
    bash "$HOME/bootstrap-claude.sh" || echo "[scad] Warning: plugin bootstrap had errors"
fi

# Working directory (clone already mounted by host)
cd /workspace/{{ workdir_key }}

# Activate venv and sync deps
source /opt/venv/bin/activate
{% if requirements_file %}
echo "[scad] Syncing Python dependencies..."
pip install --no-cache-dir -q -r {{ requirements_file }} 2>&1
{% endif %}

# Build claude command
CLAUDE_CMD="claude"
{% if claude.dangerously_skip_permissions %}
CLAUDE_CMD="$CLAUDE_CMD --dangerously-skip-permissions"
{% endif %}
{% for key, repo in repos.items() if repo.add_dir %}
CLAUDE_CMD="$CLAUDE_CMD --add-dir /workspace/{{ key }}"
{% endfor %}
{% if claude.additional_flags %}
CLAUDE_CMD="$CLAUDE_CMD {{ claude.additional_flags }}"
{% endif %}

# Disable set -e so non-zero Claude exit doesn't skip status writing
set +e

if [ -n "$HEADLESS" ]; then
    # Headless: fire and forget with stream-json
    echo "[scad] Running headless: $PROMPT"
    echo "[scad] Stream log: $STREAM_LOG"
    $CLAUDE_CMD -p --output-format stream-json "$PROMPT" > "$STREAM_LOG" 2>&1
    EXIT_CODE=$?
elif [ -n "$PROMPT" ]; then
    # Interactive with kickoff prompt: tmux + Claude with prompt pre-entered
    echo "[scad] Starting interactive session with prompt"
    tmux new-session -d -s scad "$CLAUDE_CMD '$PROMPT'; exec bash"
    # Keep container alive until scad stop
    sleep infinity
else
    # Interactive: tmux + Claude REPL
    echo "[scad] Starting interactive session"
    {% if context_prompt %}
    tmux new-session -d -s scad "$CLAUDE_CMD '{{ context_prompt }}'; exec bash"
    {% else %}
    tmux new-session -d -s scad "$CLAUDE_CMD; exec bash"
    {% endif %}
    # Keep container alive until scad stop
    sleep infinity
fi
